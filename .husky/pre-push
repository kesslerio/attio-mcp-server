# Skip hooks in CI or when explicitly requested
[ "${CI:-}" = "true" ] && exit 0
[ "${SKIP_PREPUSH:-}" = "1" ] && exit 0

# Skip validation for branch deletion pushes
while read local_ref local_sha remote_ref remote_sha; do
  if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
    echo "ğŸ—‘ï¸  Branch deletion detected - skipping pre-push validation"
    exit 0
  fi
done

# Skip validation for force deletion pushes (git push origin --delete)
if echo "$*" | grep -q "\-\-delete"; then
  echo "ğŸ—‘ï¸  Branch deletion detected - skipping pre-push validation"
  exit 0
fi

echo "ğŸ” Validating branch name..."
./build/validate_workflow.py --validate-branch || {
  echo "âŒ Branch validation failed"
  exit 1
}

echo "ğŸ” Running TypeScript check..."
npm run typecheck || {
  echo "âŒ TypeScript errors found"
  exit 1
}

echo "ğŸ” Running fast tests..."
if [ -n "${PREPUSH_TEST_CMD:-}" ]; then
  sh -lc "$PREPUSH_TEST_CMD"
else
  npm run test:offline:run --silent -- --reporter=dot --bail=1
fi || {
  echo "âŒ Tests failed"
  exit 1
}

echo "âœ… Pre-push validation complete"