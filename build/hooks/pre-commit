#!/bin/bash

# pre-commit hook to prevent Claude Code and AI attribution messages
# Place this file in .git/hooks/pre-commit and make executable with: chmod +x .git/hooks/pre-commit

# Ensure the hook is being executed
echo "Pre-commit hook is running..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "🔍 Checking for AI attribution messages in commit..."

# Get the commit message
commit_msg_file="$HOME/.git_commit_msg.txt"
if [ -f "$commit_msg_file" ]; then
  commit_msg=$(cat "$commit_msg_file")
else
  commit_msg=$(git log -1 --pretty=%B)
fi

# Patterns to check for (using fixed strings, not regex)
ATTRIBUTION_PATTERNS=(
  "Generated with Claude"
  "Generated with [Claude Code]"
  "Co-Authored-By: Claude"
  "noreply@anthropic.com"
  "Generated by AI"
  "AI-generated"
  "Generated by Claude"
  "🤖 Generated"
  "Created with Claude"
)

# Check commit message for attribution patterns (using fixed string comparison)
for pattern in "${ATTRIBUTION_PATTERNS[@]}"; do
  if [[ "$commit_msg" == *"$pattern"* ]]; then
    echo -e "${RED}Error:${NC} Commit message contains AI attribution: '${YELLOW}$pattern${NC}'"
    echo -e "Please remove the attribution from your commit message and try again."
    echo -e "AI attribution messages are not allowed as per project guidelines."
    # Suggest using prepare-commit-msg to automatically clean the message
    echo -e "${GREEN}Tip:${NC} The prepare-commit-msg hook can automatically remove AI attributions."
    echo -e "      Try committing again and the attribution should be automatically removed."
    exit 1
  fi
done

# Check staged files for attribution patterns
staged_files=$(git diff --cached --name-only)

for file in $staged_files; do
  # Skip binary files
  if [[ $(file -b --mime-type "$file" 2>/dev/null) == text/* ]]; then
    for pattern in "${ATTRIBUTION_PATTERNS[@]}"; do
      # Get all added lines and check for pattern without using regex
      added_lines=$(git diff --cached --unified=0 "$file" | grep -E "^\+" | sed 's/^\+//')
      if [[ "$added_lines" == *"$pattern"* ]]; then
        echo -e "${RED}Error:${NC} File '${YELLOW}$file${NC}' contains AI attribution: '${YELLOW}$pattern${NC}'"
        echo -e "Please remove the attribution from your changes and stage the file again."
        echo -e "AI attribution messages are not allowed as per project guidelines."
        exit 1
      fi
    done
  fi
done

echo -e "${GREEN}✅ No AI attribution messages found.${NC}"
exit 0