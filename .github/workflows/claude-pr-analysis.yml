name: Claude PR Analysis

on:
  pull_request:
    types: [opened, reopened, synchronize]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '.gitignore'
      - 'LICENSE'
      - 'docs/**'

# SPAM REDUCTION: Enable cancellation of previous runs on new commits
# Issue #651: Changed from cancel-in-progress: false to true
# Prevents multiple security analysis runs on rapid commits
concurrency:
  group: claude-pr-analysis-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  # checks: write   # enable only if you intentionally create/update Checks

# MAINTAINABILITY: Environment variables for comment markers
# Issue #651: Centralized comment text patterns for easier maintenance
env:
  SECURITY_COMMENT_MARKER: '🛡️ Automated Security Review Complete'

jobs:
  automated-security-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Skip if there are recent @claude comments to avoid conflicts
    if: ${{ !contains(github.event.pull_request.body, '@claude') }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          disable-sudo: true
          egress-policy: audit

      - name: Get changed files
        id: changed
        uses: tj-actions/changed-files@v46
        with:
          files_ignore: |
            **.md
            **.txt
            .gitignore
            LICENSE
            docs/**
            package-lock.json
            yarn.lock
            pnpm-lock.yaml

      - name: Size gate
        id: gate
        run: |
          files_count=${{ steps.changed.outputs.all_changed_files_count }}
          if [ "$files_count" -le 2 ]; then
            echo "should_analyze=false" >> $GITHUB_OUTPUT
            echo "::notice::Skipping analysis for small change ($files_count files)"
            exit 0
          fi
          echo "should_analyze=true" >> $GITHUB_OUTPUT
          echo "files_count=$files_count" >> $GITHUB_OUTPUT

      - name: Claude Analysis
        if: steps.gate.outputs.should_analyze == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: '--max-turns 6 --model claude-sonnet-4-20250514 --allowed-tools=github,repo'
          prompt: |
            Conduct a security-focused code review for this Attio MCP Server PR.

            Focus on:
            - Security vulnerabilities and credential exposure
            - API endpoint security and input validation
            - Authentication/authorization issues
            - Breaking API changes
            - Error handling and information disclosure

            Files changed: ${{ steps.changed.outputs.all_changed_files_count }}

            Output a concise markdown summary with:
            - Security Risk Assessment (High/Medium/Low/None)
            - Key Issues Found
            - Recommendations

            Keep under 2000 tokens.

      # COMMENT DEDUPLICATION: Check for existing security comment
      # Issue #651: Prevents multiple "Security Review Complete" comments on same PR
      - name: Check for existing security comment
        if: steps.gate.outputs.should_analyze == 'true' && github.event.pull_request.head.repo.full_name == github.repository
        id: comment-check
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });

              const existingComment = comments.data.find(c =>
                c.body && c.body.includes(process.env.SECURITY_COMMENT_MARKER)
              );

              console.log('existing-comment=' + (!!existingComment));
              // BOOLEAN OUTPUT FIX: Use proper core.setOutput() instead of string return
              // Issue #651: Improved from string 'true'/'false' to actual boolean
              core.setOutput('exists', !!existingComment);
              return !!existingComment;
            } catch (error) {
              console.log('Error checking for existing comments:', error.message);
              // ERROR HANDLING: On error, assume no comment exists to avoid blocking
              // Issue #651: Graceful degradation ensures workflow doesn't fail on API errors
              core.setOutput('exists', false);
              return false;
            }

      - name: Comment with slash command info
        if: steps.gate.outputs.should_analyze == 'true' && github.event.pull_request.head.repo.full_name == github.repository && steps.comment-check.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ${{ env.SECURITY_COMMENT_MARKER }}

              ✅ Security-focused analysis finished for ${{ steps.changed.outputs.all_changed_files_count }} files.

              **Manual Claude Review**: Comment \`@claude review\` to get a full interactive review.
              
              **Re-run Security Scan**: Comment \`/security review\` to re-run automated security analysis.

              ---
              *Automated Security Review by Claude Code Action*`
            });
